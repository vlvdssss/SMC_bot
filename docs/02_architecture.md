# 02. Архитектура

## Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                        run.py                               │
│                  (Orchestrator)                             │
└────────────┬────────────────────────────────────────────────┘
             │
             ├──────> MT5 Connector ────> MetaTrader 5
             │
             ├──────> Strategy Loader
             │          │
             │          ├──> XAUUSD Strategy
             │          ├──> US30 Strategy
             │          └──> [Other Strategies]
             │
             ├──────> Data Loader ────> Historical Data / Live Data
             │
             ├──────> Logger ────> Logs / Console
             │
             └──────> Results Writer ────> results/<instrument>/<year>/
```

## Компоненты системы

### 1. run.py — Orchestrator
**Назначение**: Единая точка входа

**Ответственность**:
- Инициализация MT5 подключения
- Загрузка стратегий для инструментов
- Управление циклом анализа (backtest / live)
- Координация компонентов

**НЕ делает**:
- Не содержит торговую логику
- Не анализирует рынок
- Не хранит состояние позиций

---

### 2. strategies/ — Стратегии
**Назначение**: Код стратегий для каждого инструмента

**Структура**:
```
strategies/
├── xauusd/
│   └── strategy.py       # XAUUSDStrategy класс
├── us30/
│   └── strategy.py       # US30Strategy класс
└── README.md
```

**Интерфейс стратегии**:
```python
class InstrumentStrategy:
    def analyze(self, htf_data, ltf_data):
        """
        Анализ рынка.
        Returns: {'signal': 'BUY'|'SELL'|'NONE', 'entry': float, ...}
        """
        pass
```

**Изоляция**: Каждая стратегия полностью изолирована. Нет общих зависимостей между стратегиями.

---

### 3. mt5/ — MT5 Integration
**Назначение**: Всё, что связано с MetaTrader 5

**Компоненты**:
- `connector.py` — подключение к терминалу
- `data_loader.py` — загрузка данных

**Интерфейс**:
```python
# Подключение
connector = MT5Connector()
connector.connect()

# Загрузка данных
loader = MT5DataLoader(connector)
h1_data = loader.load_history("XAUUSD", "H1", bars=100)
```

---

### 4. logging/ — Логирование
**Назначение**: Единая система логов

**Уровни**:
- DEBUG — детали анализа
- INFO — общие события (сигналы, сделки)
- WARNING — предупреждения (низкая ликвидность)
- ERROR — ошибки (MT5 disconnect)
- CRITICAL — критичные проблемы

**Формат**:
```
[2025-12-17 15:30:45] [INFO] [XAUUSD] BUY signal at 2850.50
```

---

### 5. results/ — Результаты
**Назначение**: Хранение результатов бэктестов

**Структура**:
```
results/
├── xauusd/
│   ├── 2023/
│   ├── 2024/
│   └── 2025/
└── us30/
    └── 2023/
```

**Формат файлов**: CSV с полями:
- time, symbol, signal, entry, sl, tp, result, pnl, balance

---

### 6. tests/ — Тесты и бэктесты
**Назначение**: Скрипты для запуска тестов

**Типы**:
- `backtests/` — прогоны на исторических данных
- (будущее) unit tests для компонентов

---

### 7. docs/ — Документация
**Назначение**: Вся документация на русском

**Содержание**:
- Описание проекта
- Архитектура (этот файл)
- Инструменты и стратегии
- Эксперименты
- Интерпретация результатов

---

## Поток данных

### Backtest режим:
```
1. run.py запускает backtest
2. MT5 Data Loader загружает исторические данные
3. Для каждого бара:
   a. Strategy.analyze(htf, ltf) → сигнал
   b. Симуляция сделки
   c. Запись результата
4. Сохранение в results/<instrument>/<year>/
5. Вывод метрик (WR, DD, PnL)
```

### Live режим (будущее):
```
1. run.py подключается к MT5
2. Каждые N секунд:
   a. Загрузка свежих данных
   b. Strategy.analyze() → сигнал
   c. Если сигнал → открытие позиции через MT5
3. Мониторинг открытых позиций
4. Логирование всех действий
```

---

## Разделение ответственности

### run.py
✅ Управление процессом  
❌ Торговая логика

### strategies/
✅ Анализ рынка  
✅ Генерация сигналов  
❌ Исполнение сделок

### mt5/
✅ Подключение к MT5  
✅ Загрузка данных  
❌ Анализ рынка

### logging/
✅ Логирование событий  
❌ Бизнес-логика

### results/
✅ Хранение результатов  
❌ Интерпретация

---

## Почему такая структура?

### 1. Изоляция стратегий
Каждый инструмент — отдельная папка. Изменения в XAUUSD не влияют на US30.

### 2. Масштабируемость
Добавить инструмент:
```
1. Создать strategies/eurusd/
2. Написать EURUSDStrategy
3. Добавить в run.py
```

### 3. Тестируемость
Каждый компонент тестируется независимо:
- Strategy.analyze() — unit test
- MT5 connector — integration test
- Backtest — end-to-end test

### 4. Понятность
- Код в strategies/
- Результаты в results/
- Документация в docs/

Не нужно искать, где что лежит.

---

## Принципы дизайна

### Single Responsibility
Каждый модуль отвечает за одну вещь:
- MT5 connector — только подключение
- Strategy — только анализ
- Logger — только логирование

### Open/Closed
Легко добавить новый инструмент (open), не меняя существующий код (closed).

### Dependency Inversion
Strategy не зависит от MT5 напрямую. Зависит от абстракции "данные".

---

## Расширяемость

### Добавление нового инструмента:
1. Создать `strategies/instrument/strategy.py`
2. Реализовать `InstrumentStrategy.analyze()`
3. Зарегистрировать в `run.py`

### Добавление нового компонента:
Например, Risk Manager:
1. Создать `risk/manager.py`
2. Использовать в `run.py` после получения сигнала
3. Документировать в `docs/`

---

## Текущий статус архитектуры

✅ Структура папок создана  
✅ Интерфейсы определены  
⏳ MT5 connector не реализован  
⏳ Стратегии не реализованы  
⏳ Backtest engine не реализован

---

## Следующие шаги

1. Реализовать MT5Connector
2. Реализовать MT5DataLoader
3. Перенести baseline стратегию для XAUUSD
4. Создать backtest runner в tests/
5. Запустить первый бэктест

---

**Версия**: 1.0  
**Дата**: 17 декабря 2025
